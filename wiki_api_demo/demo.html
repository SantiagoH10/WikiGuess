<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikipedia API Demo - Multi-Language Filter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #article-container {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .status {
            color: #777;
            font-style: italic;
        }
        h1 {
            color: #333;
        }
        h2 {
            margin-top: 20px;
            color: #444;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }
        #language-count {
            font-weight: bold;
            color: #2c3e50;
        }
        #min-languages {
            width: 60px;
        }
        .controls {
            margin-bottom: 20px;
        }
        #language-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Wikipedia API Demo</h1>
    <p>This page demonstrates how to fetch Wikipedia articles available in multiple languages.</p>
    
    <div class="controls">
        <label for="min-languages">Minimum languages: </label>
        <input type="number" id="min-languages" value="20" min="1" max="300">
        <button id="load-btn" class="btn">Random Article</button>
        <button id="load-popular-btn" class="btn">Most Translated</button>
        <button id="load-category-btn" class="btn">By Category</button>
    </div>
    
    <div class="controls">
        <select id="category-select" style="display:none; margin-right: 10px; padding: 5px; width: 200px;">
            <option value="Countries">Countries</option>
            <option value="Cities">Cities</option>
            <option value="Animals">Animals</option>
            <option value="Plants">Plants</option>
            <option value="Historical_figures">Historical Figures</option>
            <option value="Scientists">Scientists</option>
            <option value="Artists">Artists</option>
            <option value="Films">Films</option>
            <option value="Books">Books</option>
            <option value="Music_albums">Music Albums</option>
        </select>
        <button id="confirm-category-btn" class="btn" style="display:none;">Confirm</button>
    </div>
    
    <p id="status" class="status">Click a button to fetch an article...</p>
    
    <div id="article-container">
        <h2 id="article-title">Article will appear here</h2>
        <p>Available in <span id="language-count">0</span> languages</p>
        <div id="article-content">Loading...</div>
        <div id="language-list"></div>
    </div>
    
    <h2>API Response (Raw JSON)</h2>
    <pre id="api-response">Click a button to see the raw API response...</pre>
    
    <script>
        // DOM elements
        const loadBtn = document.getElementById('load-btn');
        const loadPopularBtn = document.getElementById('load-popular-btn');
        const statusText = document.getElementById('status');
        const articleTitle = document.getElementById('article-title');
        const articleContent = document.getElementById('article-content');
        const apiResponse = document.getElementById('api-response');
        const languageCount = document.getElementById('language-count');
        const minLanguagesInput = document.getElementById('min-languages');
        const languageList = document.getElementById('language-list');
        
        // Function to get an article by title and display it
        async function getAndDisplayArticle(title) {
            try {
                statusText.textContent = `Fetching article "${title}"...`;
                
                // Step 1: Get the page ID from the title
                const titleResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&format=json&origin=*`
                );
                
                const titleData = await titleResponse.json();
                const pageId = Object.keys(titleData.query.pages)[0];
                
                if (pageId === '-1') {
                    throw new Error(`Article "${title}" not found`);
                }
                
                // Step 2: Get language links
                const langlinksResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllimit=500&pageids=${pageId}&format=json&origin=*`
                );
                
                const langlinksData = await langlinksResponse.json();
                const langlinks = langlinksData.query.pages[pageId].langlinks || [];
                const langCount = langlinks.length;
                
                // Step 3: Get the article content
                const contentResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&pageids=${pageId}&format=json&origin=*`
                );
                
                const contentData = await contentResponse.json();
                apiResponse.textContent = JSON.stringify({
                    article: contentData,
                    langlinks: langlinksData
                }, null, 2);
                
                // Display the article extract
                const extract = contentData.query.pages[pageId].extract;
                articleTitle.textContent = title;
                articleContent.textContent = extract;
                languageCount.textContent = langCount;
                
                // Display language list
                languageList.innerHTML = '<h3>Available Languages:</h3>';
                if (langlinks.length > 0) {
                    const langHTML = langlinks.map(link => 
                        `<span style="display:inline-block;margin-right:10px;margin-bottom:5px;">${link.lang}: ${link['*']}</span>`
                    ).join('');
                    languageList.innerHTML += langHTML;
                } else {
                    languageList.innerHTML += '<p>No language links available.</p>';
                }
                
                statusText.textContent = `Article loaded successfully with ${langCount} translations!`;
                
            } catch (error) {
                console.error('Error fetching Wikipedia article:', error);
                statusText.textContent = `Error: ${error.message}`;
                articleContent.textContent = "Failed to load article content.";
            }
        }
        
        // Function to fetch a random article with at least the specified number of language translations
        async function getMultiLanguageArticle() {
            try {
                const minLanguages = parseInt(minLanguagesInput.value) || 20;
                statusText.textContent = `Searching for an article available in at least ${minLanguages} languages...`;
                
                let foundSuitableArticle = false;
                let attempts = 0;
                const maxAttempts = 10; // Limit the number of attempts
                
                while (!foundSuitableArticle && attempts < maxAttempts) {
                    attempts++;
                    statusText.textContent = `Attempt ${attempts}/${maxAttempts}: Fetching random article...`;
                    
                    // Get a random article ID
                    const randomResponse = await fetch(
                        'https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*'
                    );
                    
                    const randomData = await randomResponse.json();
                    const pageId = randomData.query.random[0].id;
                    const title = randomData.query.random[0].title;
                    
                    statusText.textContent = `Checking language count for "${title}"...`;
                    
                    // Check how many language links this article has
                    const langlinksResponse = await fetch(
                        `https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllimit=500&pageids=${pageId}&format=json&origin=*`
                    );
                    
                    const langlinksData = await langlinksResponse.json();
                    const langlinks = langlinksData.query.pages[pageId].langlinks || [];
                    const langCount = langlinks.length;
                    
                    if (langCount >= minLanguages) {
                        foundSuitableArticle = true;
                        await getAndDisplayArticle(title);
                    } else {
                        statusText.textContent = `"${title}" only has ${langCount} translations. Trying another article...`;
                    }
                }
                
                if (!foundSuitableArticle) {
                    statusText.textContent = `Couldn't find an article with at least ${minLanguages} languages after ${maxAttempts} attempts. Try again or reduce the minimum.`;
                    articleTitle.textContent = "No suitable article found";
                    articleContent.textContent = "Please try again or reduce the minimum number of languages.";
                    languageCount.textContent = "0";
                    languageList.innerHTML = '';
                }
                
            } catch (error) {
                console.error('Error fetching Wikipedia article:', error);
                statusText.textContent = `Error: ${error.message}`;
                articleContent.textContent = "Failed to load article content.";
            }
        }
        
        // Function to get articles with many language links directly
        async function getPopularMultiLanguageArticle() {
            try {
                const minLanguages = parseInt(minLanguagesInput.value) || 20;
                statusText.textContent = `Fetching large pool of articles with many translations...`;
                
                // Set the maximum number of articles to gather and the page size
                const totalArticlesToFetch = 500; // We'll try to fetch up to 500 articles total
                const pageSize = 100; // Each API request will fetch 100 articles (API maximum)
                let allArticles = [];
                let continueToken = null;
                
                // Fetch articles in batches using pagination
                while (allArticles.length < totalArticlesToFetch) {
                    // Build the API URL with pagination parameters if available
                    let apiUrl = `https://en.wikipedia.org/w/api.php?action=query&list=querypage&qppage=Mostinterwikis&qplimit=${pageSize}&format=json&origin=*`;
                    
                    if (continueToken) {
                        apiUrl += `&qpoffset=${continueToken}`;
                    }
                    
                    statusText.textContent = `Fetching articles batch ${Math.floor(allArticles.length/pageSize) + 1}...`;
                    
                    // Make the API request
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    // Add the new batch of articles to our collection
                    const newArticles = data.query.querypage.results || [];
                    allArticles = allArticles.concat(newArticles);
                    
                    // Check if there are more results to fetch
                    if (data.continue && data.continue.qpoffset) {
                        continueToken = data.continue.qpoffset;
                    } else {
                        // No more results available from the API
                        break;
                    }
                    
                    // To avoid overloading the API, limit the number of requests
                    if (allArticles.length >= totalArticlesToFetch || Math.floor(allArticles.length/pageSize) >= 5) {
                        break;
                    }
                }
                
                statusText.textContent = `Collected ${allArticles.length} articles. Selecting one at random...`;
                
                // Randomly select an article from our large pool
                const randomIndex = Math.floor(Math.random() * allArticles.length);
                const selectedArticle = allArticles[randomIndex];
                const title = selectedArticle.title;
                
                await getAndDisplayArticle(title);
                
            } catch (error) {
                console.error('Error fetching popular multilingual article:', error);
                statusText.textContent = `Error: ${error.message}`;
                articleContent.textContent = "Failed to load article content.";
            }
        }
        
        // Add click event listeners to the buttons
        loadBtn.addEventListener('click', getMultiLanguageArticle);
        loadPopularBtn.addEventListener('click', getPopularMultiLanguageArticle);
    </script>
</body>
</html>
