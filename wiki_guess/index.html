<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiGuess - Guess the Wikipedia Article!</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>WikiGuess</h1>
        <p>Guess the hidden Wikipedia article by entering words!</p>
    </header>
    
    <div class="game-container">
        <div class="game-status">
            <div>Words found: <span id="found-counter">0</span>/<span id="total-words">0</span></div>
            <div>Guesses: <span id="guess-counter">0</span></div>
        </div>
        
        <div class="controls">
            <input type="text" id="guess-input" placeholder="Enter a word to guess..." autocomplete="off">
            <button id="guess-btn">Guess</button>
            <button id="new-game-btn">New Article</button>
        </div>
        
        <div class="article-content" id="article-display"></div>
        
        <div class="hint">Hint: <span id="hint-text">This article is about a popular science topic.</span></div>
        
        <div class="stats">
            <h3>Game Stats</h3>
            <p>Articles completed: <span id="completed-counter">0</span></p>
            <p>Total guesses: <span id="total-guesses">0</span></p>
        </div>
    </div>

    <script>
        // Game state variables
        let currentArticle = null;
        let wordStatus = {};
        let foundWords = 0;
        let totalWords = 0;
        let guessCount = 0;
        let totalGuessCount = 0;
        let completedArticles = 0;

        // DOM elements
        const articleDisplay = document.getElementById('article-display');
        const guessInput = document.getElementById('guess-input');
        const guessBtn = document.getElementById('guess-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const foundCounter = document.getElementById('found-counter');
        const totalWordsDisplay = document.getElementById('total-words');
        const guessCounter = document.getElementById('guess-counter');
        const hintText = document.getElementById('hint-text');
        const completedCounter = document.getElementById('completed-counter');
        const totalGuessesDisplay = document.getElementById('total-guesses');
        const statusText = document.getElementById('status-text');
        const minLanguagesInput = document.getElementById('min-languages');

        // Initialize the game
        function initGame() {
            guessCount = 0;
            foundWords = 0;
            wordStatus = {};
            
            // Get a random article from Wikipedia
            getMultiLanguageArticle();
        }

        // Function to get an article by title and display it
        async function getAndDisplayArticle(title) {
            try {
                if (statusText) {
                    statusText.textContent = `Fetching article...`;
                }
                
                // Step 1: Get the page ID from the title
                const titleResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&format=json&origin=*`
                );
                
                const titleData = await titleResponse.json();
                const pageId = Object.keys(titleData.query.pages)[0];
                
                if (pageId === '-1') {
                    throw new Error(`Article "${title}" not found`);
                }
                
                // Step 2: Get language links
                const langlinksResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllimit=500&pageids=${pageId}&format=json&origin=*`
                );
                
                const langlinksData = await langlinksResponse.json();
                const langlinks = langlinksData.query.pages[pageId].langlinks || [];
                const langCount = langlinks.length;
                
                // Step 3: Get the article content
                const contentResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&pageids=${pageId}&format=json&origin=*`
                );
                
                const contentData = await contentResponse.json();
                
                // Get the article extract and set up the current article
                const extract = contentData.query.pages[pageId].extract;
                
                currentArticle = {
                    title: title,
                    content: extract,
                    hint: `This article is available in ${langCount} languages`
                };
                
                // Process article content
                processArticleContent(currentArticle.content);
                totalWords = Object.keys(wordStatus).filter(word => !wordStatus[word]).length;
                
                // Update display
                updateArticleDisplay();
                foundCounter.textContent = foundWords;
                totalWordsDisplay.textContent = totalWords;
                guessCounter.textContent = guessCount;
                hintText.textContent = currentArticle.hint;
                
                if (statusText) {
                    statusText.textContent = `Article loaded successfully with ${langCount} translations!`;
                }
                
            } catch (error) {
                console.error('Error fetching Wikipedia article:', error);
                if (statusText) {
                    statusText.textContent = `Error: ${error.message}`;
                }
                // Try a different article if there's an error
                getMultiLanguageArticle();
            }
        }

        // Function to fetch a random article with at least the specified number of language translations
        async function getMultiLanguageArticle() {
            try {
                const minLanguages = minLanguagesInput ? parseInt(minLanguagesInput.value) || 20 : 20;
                
                if (statusText) {
                    statusText.textContent = `Searching for an article available in at least ${minLanguages} languages...`;
                }
                
                let foundSuitableArticle = false;
                let attempts = 0;
                const maxAttempts = 20; // Limit the number of attempts
                
                while (!foundSuitableArticle && attempts < maxAttempts) {
                    attempts++;
                    
                    if (statusText) {
                        statusText.textContent = `Attempt ${attempts}/${maxAttempts}: Fetching random article...`;
                    }
                    
                    // Get a random article ID
                    const randomResponse = await fetch(
                        'https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*'
                    );
                    
                    const randomData = await randomResponse.json();
                    const pageId = randomData.query.random[0].id;
                    const title = randomData.query.random[0].title;
                    
                    if (statusText) {
                        statusText.textContent = `Checking language count for "${title}"...`;
                    }
                    
                    // Check how many language links this article has
                    const langlinksResponse = await fetch(
                        `https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllimit=500&pageids=${pageId}&format=json&origin=*`
                    );
                    
                    const langlinksData = await langlinksResponse.json();
                    const langlinks = langlinksData.query.pages[pageId].langlinks || [];
                    const langCount = langlinks.length;
                    
                    if (langCount >= minLanguages) {
                        foundSuitableArticle = true;
                        await getAndDisplayArticle(title);
                    } else {
                        if (statusText) {
                            statusText.textContent = `"${title}" only has ${langCount} translations. Trying another article...`;
                        }
                    }
                }
                
                if (!foundSuitableArticle) {
                    if (statusText) {
                        statusText.textContent = `Couldn't find an article with at least ${minLanguages} languages after ${maxAttempts} attempts. Try again or reduce the minimum.`;
                    }
                    // Fall back to a lower minimum
                    if (minLanguagesInput) {
                        minLanguagesInput.value = Math.max(5, minLanguages - 5);
                    }
                    getMultiLanguageArticle();
                }
                
            } catch (error) {
                console.error('Error fetching Wikipedia article:', error);
                if (statusText) {
                    statusText.textContent = `Error: ${error.message}`;
                }
            }
        }

        // Process article content into words and initialize word status
        function processArticleContent(content) {
            // Split content into words and remove punctuation
            const words = content.split(/\s+/).map(word => {
                return word.replace(/[^\w']/g, '');
            }).filter(word => word.length > 0);
            
            // Create unique word map (case insensitive)
            const uniqueWords = {};
            words.forEach(word => {
                const lowerWord = word.toLowerCase();
                // Skip common short words
                if (lowerWord.length < 3 || ['the', 'and', 'for', 'are', 'was', 'its', 'who', 'has', 'had', 'his', 'her', 'this', 'that', 'they', 'with', 'from'].includes(lowerWord)) {
                    wordStatus[lowerWord] = true; // Auto-reveal common words
                } else {
                    uniqueWords[lowerWord] = word;
                    if (!wordStatus.hasOwnProperty(lowerWord)) {
                        wordStatus[lowerWord] = false;
                    }
                }
            });
            
            return words;
        }

        // Update the article display base
        function updateArticleDisplay() {
            if (!currentArticle || !currentArticle.content) {
                articleDisplay.innerHTML = "Loading article...";
                return;
            }
            
            // Create a display version with hidden/revealed words
            const words = currentArticle.content.split(/(\s+)/).map(part => {
                // Keep spaces as they are
                if (part.trim() === '') {
                    return part;
                }
                
                // Get the word without punctuation
                const word = part.replace(/[^\w']/g, '');
                if (word === '') return part; // Return punctuation as is
                
                const lowerWord = word.toLowerCase();
                const revealed = wordStatus[lowerWord];
                
                if (revealed) {
                    return `<span class="revealed-word">${part}</span>`;
                } else {
                    return `<span class="hidden-word">${part}</span>`;
                }
            });
            
            articleDisplay.innerHTML = words.join('');
        }

        // Handle guess submission
        function submitGuess() {
            if (!currentArticle) return;
            
            const guess = guessInput.value.trim().toLowerCase();
            
            if (guess.length < 3) {
                alert("Please enter a word with at least 3 characters.");
                return;
            }
            
            guessInput.value = '';
            guessCount++;
            totalGuessCount++;
            guessCounter.textContent = guessCount;
            if (totalGuessesDisplay) {
                totalGuessesDisplay.textContent = totalGuessCount;
            }
            
            let found = false;
            
            // Check if the word exists in the article
            if (wordStatus.hasOwnProperty(guess) && !wordStatus[guess]) {
                wordStatus[guess] = true;
                foundWords++;
                foundCounter.textContent = foundWords;
                found = true;
                
                // Check if all words are found
                if (foundWords === totalWords) {
                    setTimeout(() => {
                        alert(`Congratulations! You've found all words! The article was about "${currentArticle.title}"`);
                        completedArticles++;
                        completedCounter.textContent = completedArticles;
                        initGame();
                    }, 500);
                }
            }
            
            updateArticleDisplay();
            return found;
        }

        // Add a function to guess the title of the article
        function guessTitle() {
            if (!currentArticle) return;
            
            const titleGuess = prompt("What do you think the article is about?").trim().toLowerCase();
            const actualTitle = currentArticle.title.toLowerCase();
            
            if (titleGuess === actualTitle) {
                alert("Correct! You guessed the title!");
                completedArticles++;
                completedCounter.textContent = completedArticles;
                initGame();
            } else {
                alert("That's not correct. Keep trying!");
            }
        }

        // Event listeners
        if (guessBtn) {
            guessBtn.addEventListener('click', submitGuess);
        }

        if (guessInput) {
            guessInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitGuess();
                }
            });
        }

        if (newGameBtn) {
            newGameBtn.addEventListener('click', () => {
                initGame();
            });
        }

        // Add event listener for title guess button if it exists
        const guessTitleBtn = document.getElementById('guess-title-btn');
        if (guessTitleBtn) {
            guessTitleBtn.addEventListener('click', guessTitle);
        }

        // Start the game
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
        });
    </script>
</body>
</html>