<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiGuess - Guess the Wikipedia Article!</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <button id="new-game-btn">
            <span class="shadow"></span>
            <span class="edge"></span>
            <span class="front text"> New Article </span>
        </button>
        <h1>WikiGuess</h1>
        <p>Guess the hidden Wikipedia article by entering words! Win by guessing the exact title!</p>
        <span id="timer">Time: 00:00</span> <!-- Timer element -->
    </header>
    
    <div class="game-wrapper">
        <div id="loading-overlay" class="active">
            <button id="launch-game-btn">
                <span class="shadow"></span>
                <span class="edge"></span>
                <span class="front text"> Launch Game </span>
            </button>
        </div>
        <div class="game-container">
            <div id="loading-indicator">
                <div class="loading-animation">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
            
            <div class="game-status">
                <div>Words found: <span id="found-counter">0</span>/<span id="total-words">0</span></div>
                <div>Guesses: <span id="guess-counter">0</span></div>
            </div>
            
            <div class="controls">
                <input type="text" id="guess-input" placeholder="Enter a word or guess the title..." autocomplete="off">
                <button id="guess-btn">
                    <span class="shadow"></span>
                    <span class="edge"></span>
                    <span class="front text"> Guess
                    </span>
                </button>
            </div>
            
            <div class="article-content" id="article-display"></div>

            <div class="hint">
                <span id="hint-text">
                </span>
            </div>

                    
            <div class="stats">
                <h3>Game Stats</h3>
                <p>Total guesses: <span id="total-guesses">0</span></p>
                <div class="guess-list-container">
                    <h4>Your Guesses:</h4>
                    <div id="guess-list" class="guess-list"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Game state variables
        let currentArticle = null;
        let wordStatus = {};
        let foundWords = 0;
        let totalWords = 0;
        let guessCount = 0;
        let totalGuessCount = 0;
        let completedArticles = 0;
        let isLoading = false;
        let titleWords = []; // New variable to track title words

        // DOM elements
        const articleDisplay = document.getElementById('article-display');
        const guessInput = document.getElementById('guess-input');
        const guessBtn = document.getElementById('guess-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const foundCounter = document.getElementById('found-counter');
        const totalWordsDisplay = document.getElementById('total-words');
        const guessCounter = document.getElementById('guess-counter');
        const hintText = document.getElementById('hint-text');
        const completedCounter = document.getElementById('completed-counter');
        const totalGuessesDisplay = document.getElementById('total-guesses');
        const loadingIndicator = document.getElementById('loading-indicator');
        const minLanguagesInput = document.getElementById('min-languages');
        const guessList = document.getElementById('guess-list');
        const loadingOverlay = document.getElementById('loading-overlay');
        const launchGameBtn = document.getElementById('launch-game-btn');

        // Initialize the game
        function initGame() {
            guessCount = 0;
            foundWords = 0;
            wordStatus = {};
            titleWords = []; // Reset title words
            
            // Show loading
            setLoading(false);
            
            // Get a random article from Wikipedia
            getMultiLanguageArticle();
        }

        // Function to show/hide loading indicator
        function setLoading(isLoading) {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingIndicator = document.getElementById('loading-indicator');

            if (isLoading) {
                loadingOverlay.classList.add('active'); // Show the overlay
                loadingIndicator.style.display = 'block'; // Show the loading animation
                launchGameBtn.style.display = 'none'; // Hide the launch game button
            } else {
                loadingOverlay.classList.remove('active'); // Hide the overlay
                loadingIndicator.style.display = 'none'; // Hide the loading animation
            }
        }

        // Function to get an article by title and display it
        async function getAndDisplayArticle(title) {
            try {
                setLoading(true);
                
                // Step 1: Get the page ID from the title
                const titleResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&format=json&origin=*`
                );
                
                const titleData = await titleResponse.json();
                const pageId = Object.keys(titleData.query.pages)[0];
                
                if (pageId === '-1') {
                    throw new Error(`Article not found`);
                }
                
                // Step 2: Get language links
                const langlinksResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllimit=500&pageids=${pageId}&format=json&origin=*`
                );
                
                const langlinksData = await langlinksResponse.json();
                const langlinks = langlinksData.query.pages[pageId].langlinks || [];
                const langCount = langlinks.length;
                
                // Step 3: Get the article content
                const contentResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&pageids=${pageId}&format=json&origin=*`
                );
                
                const contentData = await contentResponse.json();
                
                // Get the article extract and set up the current article
                const extract = contentData.query.pages[pageId].extract;

                const processedContent = handleParentheses(extract);
                
                currentArticle = {
                    title: title,
                    content: processedContent,
                    hint: `This article is available in ${langCount} languages`
                };

                function handleParentheses(text) {
                    // Option 1: Remove parenthetical content entirely
                    return text.replace(/\s*\([^)]*\)/g, '');
                    
                    // Option 2: Mark parenthetical content for special treatment
                    /*return text.replace(/\(([^)]*)\)/g, (match, contents) => {
                        // Replace the contents with a special marker or process them differently
                        return `(${contents})`; // Or any special treatment you want
                    });
                    */
                }
                
                // Process article content
                processArticleContent(currentArticle.content);
                
                // Process the title separately to ensure title words are in wordStatus
                processTitleWords(currentArticle.title);
                
                totalWords = Object.keys(wordStatus).filter(word => !wordStatus[word]).length;

                startTimer(); // Start the timer
                
                // Update display
                updateArticleDisplay();
                foundCounter.textContent = foundWords;
                totalWordsDisplay.textContent = totalWords;
                guessCounter.textContent = guessCount;
                hintText.textContent = currentArticle.hint;
                
                setLoading(false);
                
            } catch (error) {
                console.error('Error fetching Wikipedia article:', error);
                setLoading(false); // Hide the loading animation in case of an error
                alert(`Error: ${error.message}. Trying another article...`);
                getMultiLanguageArticle(); // Try a different article
            }
        }

        // Function to fetch a random article with at least the specified number of language translations
        async function getMultiLanguageArticle() {
            try {
                const minLanguages = minLanguagesInput ? parseInt(minLanguagesInput.value) || 50 : 50;
                
                setLoading(true);
                
                let foundSuitableArticle = false;
                let attempts = 0;
                const maxAttempts = 300; // Limit the number of attempts
                
                while (!foundSuitableArticle && attempts < maxAttempts) {
                    attempts++;
                    
                    // Get a random article ID
                    const randomResponse = await fetch(
                        'https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*'
                    );
                    
                    const randomData = await randomResponse.json();
                    const pageId = randomData.query.random[0].id;
                    const title = randomData.query.random[0].title;
                    
                    // Check how many language links this article has
                    const langlinksResponse = await fetch(
                        `https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllimit=500&pageids=${pageId}&format=json&origin=*`
                    );
                    
                    const langlinksData = await langlinksResponse.json();
                    const langlinks = langlinksData.query.pages[pageId].langlinks || [];
                    const langCount = langlinks.length;
                    
                    if (langCount >= minLanguages) {
                        foundSuitableArticle = true;
                        await getAndDisplayArticle(title);
                    }
                }
                
                if (!foundSuitableArticle) {
                    alert(`Couldn't find an article with at least ${minLanguages} languages after ${maxAttempts} attempts. Trying with a lower minimum...`);
                    // Fall back to a lower minimum
                    if (minLanguagesInput) {
                        minLanguagesInput.value = Math.max(5, minLanguages - 5);
                    }
                    getMultiLanguageArticle();
                }
                
            } catch (error) {
                console.error('Error fetching Wikipedia article:', error);
                alert(`Error: ${error.message}. Trying again...`);
                setTimeout(getMultiLanguageArticle, 2000); // Try again after a short delay
            } finally {
                setLoading(false); // Hide the loading animation
            }
        }

        // Process article content into words and initialize word status
        function processArticleContent(content) {
            // Split content into words and remove punctuation
            const words = content.split(/\s+/).map(word => {
                return word.replace(/[^\w']/g, ''); // Remove punctuation
            }).filter(word => word.length > 0); // Remove empty words

            // Create unique word map (case insensitive)
            const uniqueWords = {};
            words.forEach(word => {
                const lowerWord = word.toLowerCase();

                // Skip common short words and auto-reveal them
                if (
                    lowerWord.length < 3 || 
                    ['the', 'and', 'for', 'are', 'was', 'its', 'who', 'has', 'had', 'his', 'her', 'this', 'that', 'they', 'with', 'from'].includes(lowerWord)
                ) {
                    wordStatus[lowerWord] = true; // Auto-reveal common words
                } else {
                    uniqueWords[lowerWord] = word; // Add to unique words map
                    if (!wordStatus.hasOwnProperty(lowerWord)) {
                        wordStatus[lowerWord] = false; // Initialize word as not found
                    }
                }
            });

            return Object.keys(uniqueWords); // Return unique words
        }

        // Process title words to ensure they're in wordStatus
        function processTitleWords(title) {
            // Split title into words and clean them
            const words = title.split(/\s+/).map(word => {
                return word.replace(/[^\w']/g, ''); // Remove punctuation
            }).filter(word => word.length > 0); // Remove empty words
            
            // Store title words for later use
            titleWords = words.map(word => word.toLowerCase());
            
            // Add title words to wordStatus if not already present
            words.forEach(word => {
                const lowerWord = word.toLowerCase();
                if (lowerWord.length >= 3 && !['the', 'and', 'for', 'are', 'was', 'its', 'who', 'has', 'had', 'his', 'her', 'this', 'that', 'they', 'with', 'from'].includes(lowerWord)) {
                    // Only add if not already in wordStatus
                    if (!wordStatus.hasOwnProperty(lowerWord)) {
                        wordStatus[lowerWord] = false; // Initialize as not found
                    }
                }
            });
        }

        // Update the article display base
        function updateArticleDisplay() {
            if (!currentArticle || !currentArticle.content) {
                articleDisplay.innerHTML = "Loading article...";
                return;
            }

            // Create a copy of the article content for display
            let displayContent = currentArticle.content;
            
            // Split the content into words while preserving spacing and punctuation
            const parts = displayContent.split(/(\s+|[.,;()\-])/);
            
            // Create HTML with proper word styling
            const html = parts.map(part => {
                // Keep spaces and punctuation as they are
                if (part.trim() === '' || /[.,;()\-]/.test(part)) {
                    return part; // Show punctuation and spaces immediately
                }

                // Get the word without punctuation
                const cleanWord = part.replace(/[^\w']/g, ''); 
                if (cleanWord === '') return part; // Return punctuation as is

                const lowerWord = cleanWord.toLowerCase();
                
                // Check if word should be revealed
                if (
                    lowerWord.length <= 2 || 
                    wordStatus[lowerWord] === true || 
                    (titleWords.includes(lowerWord) && guessCount > 0 && checkTitleGuess('')) // Reveal title words when title is guessed
                ) {
                    return `<span class="revealed-word">${part}</span>`;
                } else {
                    return `<span class="hidden-word">${part}</span>`;
                }
            }).join('');
            
            articleDisplay.innerHTML = html;
        }

        function normalizeWord(word) {
            // Basic normalization - lowercase and trim
            return word.toLowerCase().trim();
        }

        // Check if the guess matches the article title
        function checkTitleGuess(guess) {
            if (!currentArticle) return false;

            if (guess === '') {
                // Special case for updating display only (no actual guess)
                return false;
            }

            const normalizedGuess = normalizeWord(guess);
            const normalizedTitle = normalizeWord(currentArticle.title);

            // Remove text inside parentheses or after a comma for comparison
            const simplifiedTitle = normalizedTitle
                .replace(/\s*\(.*?\)/g, '') // Remove text inside parentheses
                .replace(/\s*,.*$/, '') // Remove text after a comma
                .trim();

            // Check for exact match or close match
            if (normalizedGuess === simplifiedTitle) {
                return true;
            }

            // Check if guess is very close to title (e.g., missing "The" at the beginning)
            if (simplifiedTitle.startsWith('the ') && normalizedGuess === simplifiedTitle.substring(4)) {
                return true;
            }

            return false;
        }

        // Handle guess submission
        function submitGuess() {
            if (!currentArticle) return;
            
            const guess = normalizeWord(guessInput.value);
            
            if (guess.length < 3) {
                guessInput.value = ''; // Clear the input
                return;
            }
            
            guessInput.value = '';
            guessCount++;
            totalGuessCount++;
            guessCounter.textContent = guessCount;
            if (totalGuessesDisplay) {
                totalGuessesDisplay.textContent = totalGuessCount;
            }

            // Add the guess to the guess list
            const guessItem = document.createElement('div');
            guessItem.textContent = guess;
            guessList.appendChild(guessItem);
            
            // Check if the guess matches the article title
            if (checkTitleGuess(guess)) {
                stopTimer(); // Stop the timer

                // Mark all title words as found
                titleWords.forEach(word => {
                    if (word.length >= 3) {
                        wordStatus[word] = true;
                    }
                });
                
                // Reveal all words
                Object.keys(wordStatus).forEach(word => {
                    wordStatus[word] = true;
                });
                
                foundWords = totalWords;
                foundCounter.textContent = foundWords;
                updateArticleDisplay();
                
                setTimeout(() => {
                    alert(`Congratulations! You've guessed the article title: "${currentArticle.title}"!`);
                    completedArticles++;
                    if (completedCounter) {
                        completedCounter.textContent = completedArticles;
                    }
                }, 500);
                return true;
            }
            
            let found = false;
            
            // Check if the word exists in the article
            if (wordStatus.hasOwnProperty(guess) && !wordStatus[guess]) {
                wordStatus[guess] = true;
                foundWords++;
                foundCounter.textContent = foundWords;
                found = true;

                // Check if all words are found
                if (foundWords === totalWords) {
                    setTimeout(() => {
                        alert(`Congratulations! You've found all words! The article was about "${currentArticle.title}"`);
                        completedArticles++;
                        if (completedCounter) {
                            completedCounter.textContent = completedArticles;
                        }
                        initGame();
                    }, 500);
                }
            }
            
            updateArticleDisplay();
            return found;
        }

        let timerInterval; // Variable to store the timer interval

        function startTimer() {
            const timerElement = document.getElementById('timer');
            let seconds = 0;

            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // Update the timer every second
            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerElement.textContent = `Time: ${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }, 1000);
        }

        function stopTimer() {
            // Stop the timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        // Event listeners
        if (guessBtn) {
            guessBtn.addEventListener('click', submitGuess);
        }

        if (guessInput) {
            guessInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitGuess();
                }
            });
        }

        if (newGameBtn) {
            newGameBtn.addEventListener('click', () => {
                stopTimer();
                initGame();
            });
        }

        if (launchGameBtn) {
            launchGameBtn.addEventListener('click', () => {
                setLoading(false); // Hide the overlay
                initGame(); // Start the game
            });
        }
    </script>
</body>
</html>