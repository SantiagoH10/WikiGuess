<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiGuess - Guess the Wikipedia Article!</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>WikiGuess</h1>
        <p>Guess the hidden Wikipedia article by entering words! Win by guessing the exact title!</p>
    </header>
    
    <div class="game-container">
        <div id="loading-indicator">
            <div class="loading-animation">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
        
        <div class="game-status">
            <div>Words found: <span id="found-counter">0</span>/<span id="total-words">0</span></div>
            <div>Guesses: <span id="guess-counter">0</span></div>
        </div>
        
        <div class="controls">
            <input type="text" id="guess-input" placeholder="Enter a word or guess the title..." autocomplete="off">
            <button id="guess-btn">
                <span class="shadow"></span>
                <span class="edge"></span>
                <span class="front text"> Guess
                </span>
              </button>
            <button id="new-game-btn">
                <span class="shadow"></span>
                <span class="edge"></span>
                <span class="front text"> New Article
                </span>
            </button>
        </div>
        
        <div class="article-content" id="article-display"></div>
        
        <div class="hint">Hint: <span id="hint-text">This article is about a popular science topic.</span></div>
        
        <div class="stats">
            <h3>Game Stats</h3>
            <p>Total guesses: <span id="total-guesses">0</span></p>
            <div class="guess-list-container">
                <h4>Your Guesses:</h4>
                <div id="guess-list" class="guess-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Game state variables
        let currentArticle = null;
        let wordStatus = {};
        let foundWords = 0;
        let totalWords = 0;
        let guessCount = 0;
        let totalGuessCount = 0;
        let completedArticles = 0;
        let isLoading = false;

        // DOM elements
        const articleDisplay = document.getElementById('article-display');
        const guessInput = document.getElementById('guess-input');
        const guessBtn = document.getElementById('guess-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const foundCounter = document.getElementById('found-counter');
        const totalWordsDisplay = document.getElementById('total-words');
        const guessCounter = document.getElementById('guess-counter');
        const hintText = document.getElementById('hint-text');
        const completedCounter = document.getElementById('completed-counter');
        const totalGuessesDisplay = document.getElementById('total-guesses');
        const loadingIndicator = document.getElementById('loading-indicator');
        const minLanguagesInput = document.getElementById('min-languages');
        const guessList = document.getElementById('guess-list');

        // Initialize the game
        function initGame() {
            guessCount = 0;
            foundWords = 0;
            wordStatus = {};
            
            // Show loading
            setLoading(true);
            
            // Get a random article from Wikipedia
            getMultiLanguageArticle();
        }

        // Function to show/hide loading indicator
        function setLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.style.display = 'block';
                articleDisplay.style.display = 'none';
            } else {
                loadingIndicator.style.display = 'none';
                articleDisplay.style.display = 'block';
            }
        }
        // Function to get an article by title and display it
        async function getAndDisplayArticle(title) {
            try {
                setLoading(true);
                
                // Step 1: Get the page ID from the title
                const titleResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&format=json&origin=*`
                );
                
                const titleData = await titleResponse.json();
                const pageId = Object.keys(titleData.query.pages)[0];
                
                if (pageId === '-1') {
                    throw new Error(`Article not found`);
                }
                
                // Step 2: Get language links
                const langlinksResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllimit=500&pageids=${pageId}&format=json&origin=*`
                );
                
                const langlinksData = await langlinksResponse.json();
                const langlinks = langlinksData.query.pages[pageId].langlinks || [];
                const langCount = langlinks.length;
                
                // Step 3: Get the article content
                loadingIndicator.textContent = `Loading content...`;
                const contentResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&pageids=${pageId}&format=json&origin=*`
                );
                
                const contentData = await contentResponse.json();
                
                // Get the article extract and set up the current article
                const extract = contentData.query.pages[pageId].extract;
                
                currentArticle = {
                    title: title,
                    content: extract,
                    hint: `This article is available in ${langCount} languages`
                };
                
                // Process article content
                processArticleContent(currentArticle.content);
                totalWords = Object.keys(wordStatus).filter(word => !wordStatus[word]).length;
                
                // Update display
                updateArticleDisplay();
                foundCounter.textContent = foundWords;
                totalWordsDisplay.textContent = totalWords;
                guessCounter.textContent = guessCount;
                hintText.textContent = currentArticle.hint;
                
                setLoading(false);
                
            } catch (error) {
                console.error('Error fetching Wikipedia article:', error);
                setLoading(false); // Hide the loading animation in case of an error
                alert(`Error: ${error.message}. Trying another article...`);
                getMultiLanguageArticle(); // Try a different article
            }
        }

        // Function to fetch a random article with at least the specified number of language translations
        async function getMultiLanguageArticle() {
            try {
                const minLanguages = minLanguagesInput ? parseInt(minLanguagesInput.value) || 30 : 30;
                
                setLoading(true);
                
                let foundSuitableArticle = false;
                let attempts = 0;
                const maxAttempts = 100; // Limit the number of attempts
                
                while (!foundSuitableArticle && attempts < maxAttempts) {
                    attempts++;
                    
                    loadingIndicator.textContent = `Attempt ${attempts}/${maxAttempts}: Fetching random article...`;
                    
                    // Get a random article ID
                    const randomResponse = await fetch(
                        'https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*'
                    );
                    
                    const randomData = await randomResponse.json();
                    const pageId = randomData.query.random[0].id;
                    const title = randomData.query.random[0].title;
                    
                    // Check how many language links this article has
                    const langlinksResponse = await fetch(
                        `https://en.wikipedia.org/w/api.php?action=query&prop=langlinks&lllimit=500&pageids=${pageId}&format=json&origin=*`
                    );
                    
                    const langlinksData = await langlinksResponse.json();
                    const langlinks = langlinksData.query.pages[pageId].langlinks || [];
                    const langCount = langlinks.length;
                    
                    if (langCount >= minLanguages) {
                        foundSuitableArticle = true;
                        await getAndDisplayArticle(title);
                    }
                }
                
                if (!foundSuitableArticle) {
                    alert(`Couldn't find an article with at least ${minLanguages} languages after ${maxAttempts} attempts. Trying with a lower minimum...`);
                    // Fall back to a lower minimum
                    if (minLanguagesInput) {
                        minLanguagesInput.value = Math.max(5, minLanguages - 5);
                    }
                    getMultiLanguageArticle();
                }
                
            } catch (error) {
                console.error('Error fetching Wikipedia article:', error);
                alert(`Error: ${error.message}. Trying again...`);
                setTimeout(getMultiLanguageArticle, 2000); // Try again after a short delay
            } finally {
                setLoading(false); // Hide the loading animation
            }
        }

        // Process article content into words and initialize word status
        function processArticleContent(content) {
            // Split content into words and remove punctuation
            const words = content.split(/\s+/).map(word => {
                return word.replace(/[^\w']/g, '');
            }).filter(word => word.length > 0);
            
            // Create unique word map (case insensitive)
            const uniqueWords = {};
            words.forEach(word => {
                const lowerWord = word.toLowerCase();
                // Skip common short words
                if (lowerWord.length < 3 || ['the', 'and', 'for', 'are', 'was', 'its', 'who', 'has', 'had', 'his', 'her', 'this', 'that', 'they', 'with', 'from'].includes(lowerWord)) {
                    wordStatus[lowerWord] = true; // Auto-reveal common words
                } else {
                    uniqueWords[lowerWord] = word;
                    if (!wordStatus.hasOwnProperty(lowerWord)) {
                        wordStatus[lowerWord] = false;
                    }
                }
            });
            
            return words;
        }

        // Update the article display base
        function updateArticleDisplay() {
            if (!currentArticle || !currentArticle.content) {
                articleDisplay.innerHTML = "Loading article...";
                return;
            }
            
            // Create a display version with hidden/revealed words
            const words = currentArticle.content.split(/(\s+)/).map(part => {
                // Keep spaces as they are
                if (part.trim() === '') {
                    return part;
                }
                
                // Get the word without punctuation
                const word = part.replace(/[^\w']/g, '');
                if (word === '') return part; // Return punctuation as is
                
                const lowerWord = word.toLowerCase();
                const revealed = wordStatus[lowerWord];
                
                if (revealed) {
                    return `<span class="revealed-word">${part}</span>`;
                } else {
                    return `<span class="hidden-word">${part}</span>`;
                }
            });
            
            articleDisplay.innerHTML = words.join('');
        }

        // Check if the guess matches the article title
        function checkTitleGuess(guess) {
            if (!currentArticle) return false;
            
            const normalizedGuess = guess.toLowerCase().trim();
            const normalizedTitle = currentArticle.title.toLowerCase().trim();
            
            // Check for exact match or close match
            if (normalizedGuess === normalizedTitle) {
                return true;
            }
            
            // Check if guess is very close to title (e.g. missing "The" at beginning)
            if (normalizedTitle.startsWith('the ') && normalizedGuess === normalizedTitle.substring(4)) {
                return true;
            }
            
            return false;
        }

        // Handle guess submission
        function submitGuess() {
            if (!currentArticle) return;
            
            const guess = guessInput.value.trim().toLowerCase();
            
            if (guess.length < 3) {
                alert("Please enter a word with at least 3 characters.");
                return;
            }
            
            guessInput.value = '';
            guessCount++;
            totalGuessCount++;
            guessCounter.textContent = guessCount;
            if (totalGuessesDisplay) {
                totalGuessesDisplay.textContent = totalGuessCount;
            }

            // Add the guess to the guess list
            const guessItem = document.createElement('div');
            guessItem.textContent = guess;
            guessList.appendChild(guessItem);
            
            // Check if the guess matches the article title
            if (checkTitleGuess(guess)) {
                // Reveal all words
                Object.keys(wordStatus).forEach(word => {
                    wordStatus[word] = true;
                });
                foundWords = totalWords;
                foundCounter.textContent = foundWords;
                updateArticleDisplay();
                
                setTimeout(() => {
                    alert(`Congratulations! You've guessed the article title: "${currentArticle.title}"!`);
                    completedArticles++;
                    completedCounter.textContent = completedArticles;
                    initGame();
                }, 500);
                return true;
            }
            
            let found = false;
            
            // Check if the word exists in the article
            if (wordStatus.hasOwnProperty(guess) && !wordStatus[guess]) {
                wordStatus[guess] = true;
                foundWords++;
                foundCounter.textContent = foundWords;
                found = true;
                
                // Check if all words are found
                if (foundWords === totalWords) {
                    setTimeout(() => {
                        alert(`Congratulations! You've found all words! The article was about "${currentArticle.title}"`);
                        completedArticles++;
                        completedCounter.textContent = completedArticles;
                        initGame();
                    }, 500);
                }
            }
            
            updateArticleDisplay();
            return found;
        }

        // Event listeners
        if (guessBtn) {
            guessBtn.addEventListener('click', submitGuess);
        }

        if (guessInput) {
            guessInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitGuess();
                }
            });
        }

        if (newGameBtn) {
            newGameBtn.addEventListener('click', () => {
                initGame();
            });
        }

        // Start the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
        });
        
        // Start the game immediately (in case DOMContentLoaded already fired)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGame);
        } else {
            initGame();
        }
    </script>
</body>
</html>